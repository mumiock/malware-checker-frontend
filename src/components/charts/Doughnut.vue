<template>
  <div :class="containerClass">
    <canvas id="mychartdoughnut" ref="chart"></canvas>
  </div>
</template>
<script>
import { onMounted, ref, watch } from "vue";
import { Chart, registerables } from "chart.js";
Chart.register(...registerables);

export default {
  props: {
    data: {
      type: Object,
    },
    containerClass: {
      type: String,
      default: "chart-container",
    },
    shadow: {
      type: Boolean,
      default: false,
    },
  },
  setup(props, { refs }) {
    const chartCanvas = ref(null);
    var myChart;
    const initializeChart = () => {
      const canvas = document.getElementById("mychartdoughnut");
      chartCanvas.value = canvas.getContext("2d");

      const centerTextPlugin = {
        afterDatasetsUpdate: function (chart) {},
        beforeEvent: function (chart, event, options) {
          var firstPoint = chart.getElementsAtEventForMode(
            event,
            "point",
            options
          );

          if (firstPoint.length > 0) {
            chart.pointIndex = firstPoint[0].index;
            chart.pointDataIndex = firstPoint[0].datasetIndex;
            chart.pointAvailable = true;
          }
        },
      };
      const chartTooltip = {
        backgroundColor: "#cfe2f3",
        titleFontColor: "#9db7e5",
        borderColor: "#6291a9",
        borderWidth: 0.5,
        bodyFontColor: "#ffecc6",
        bodySpacing: 10,
        xPadding: 15,
        yPadding: 15,
        cornerRadius: 0.15,
      };
      const doughnutChartOptions = {
        legend: {
          position: "bottom",
          labels: {
            padding: 30,
            usePointStyle: true,
            fontSize: 12,
          },
        },
        responsive: true,
        maintainAspectRatio: false,
        title: {
          display: false,
        },
        cutoutPercentage: 80,
        layout: {
          padding: {
            bottom: 20,
          },
        },
        tooltips: chartTooltip,
      };

      const ctx = chartCanvas.value;
      myChart = new Chart(ctx, {
        type: props.shadow ? "doughnutWithShadow" : "doughnut",
        data: props.data,
        options: doughnutChartOptions,
        plugins: [centerTextPlugin],
      });
    };
    onMounted(() => {
      initializeChart();
    });
    watch(
      () => props.data,
      (newData) => {
        if (myChart) {
          myChart.data = newData;
          myChart.update();
        } else {
          initializeChart();
        }
      }
    );
    return {
      chartCanvas,
    };
  },
};
</script>
